{% extends "base.html" %}
{% block title %}{{ item.label }} - KBM{% endblock %}

{% block content %}
<style>
  .details-container {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 20px;
    margin-bottom: 20px;
  }
  @media (max-width: 1024px) {
    .details-container {
      grid-template-columns: 1fr;
    }
  }
  .info-card, .actions-card, .checkouts-card, .history-card, .pieces-card {
    background: var(--color-bg-elevated);
    border: 1px solid var(--color-border);
    border-radius: 12px;
    padding: 20px;
  }
  .info-card h2, .actions-card h2, .checkouts-card h2, .history-card h2, .pieces-card h2 {
    margin: 0 0 16px 0;
    font-size: 18px;
    font-weight: 600;
  }
  .info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
  }
  .info-item {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }
  .info-label {
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
    color: var(--color-muted);
  }
  .info-value {
    font-size: 14px;
    color: var(--color-text);
  }
  .info-value.large {
    font-size: 18px;
    font-weight: 600;
  }
  .actions-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
    gap: 12px;
  }
  .checkout-item {
    padding: 12px;
    background: rgba(96, 165, 250, 0.08);
    border: 1px solid rgba(96, 165, 250, 0.2);
    border-radius: 8px;
    margin-bottom: 12px;
  }
  .checkout-item:last-child {
    margin-bottom: 0;
  }
  .checkout-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
  }
  .checkout-name {
    font-weight: 600;
    font-size: 14px;
  }
  .checkout-qty {
    background: rgba(96, 165, 250, 0.2);
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 600;
  }
  .checkout-details {
    font-size: 13px;
    color: var(--color-muted);
    line-height: 1.6;
  }
  .activity-item {
    padding: 12px 0;
    border-bottom: 1px solid var(--color-border);
  }
  .activity-item:last-child {
    border-bottom: none;
  }
  .activity-header {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    margin-bottom: 4px;
  }
  .activity-action {
    font-weight: 600;
    font-size: 14px;
  }
  .activity-time {
    font-size: 12px;
    color: var(--color-muted);
  }
  .activity-summary {
    font-size: 13px;
    color: var(--color-text);
    margin-bottom: 4px;
  }
  .activity-user {
    font-size: 12px;
    color: var(--color-muted);
  }
  .piece-item {
    padding: 10px;
    background: var(--color-bg);
    border: 1px solid var(--color-border);
    border-radius: 6px;
    margin-bottom: 8px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .modal-root {
    position: fixed;
    inset: 0;
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 40;
  }
  .modal-root.show {
    display: flex;
  }
  .modal-backdrop {
    position: absolute;
    inset: 0;
    background: rgba(15, 23, 42, 0.65);
  }
  .modal-dialog {
    position: relative;
    width: min(440px, 92vw);
    background: var(--color-panel);
    border-radius: 16px;
    border: 1px solid var(--color-border);
    padding: 24px;
    box-shadow: 0 24px 48px rgba(15, 23, 42, 0.35);
  }
  .modal-dialog h3 {
    margin: 0;
    font-size: 18px;
    font-weight: 600;
  }
  .modal-body {
    display: flex;
    flex-direction: column;
    gap: 14px;
    margin: 18px 0;
  }
  .modal-field label {
    font-size: 13px;
    font-weight: 600;
    display: block;
    margin-bottom: 6px;
    color: var(--color-muted);
  }
  .modal-field input,
  .modal-field select,
  .modal-field textarea {
    width: 100%;
    padding: 10px 12px;
    border-radius: 10px;
    border: 1px solid var(--color-border);
    background: rgba(148, 163, 184, 0.08);
    color: var(--color-text);
    font-size: 14px;
  }
  .modal-field input:focus,
  .modal-field select:focus,
  .modal-field textarea:focus {
    outline: none;
    border-color: var(--color-accent);
    box-shadow: 0 0 0 3px var(--color-accent-soft);
  }
  .modal-actions {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
  }
  .piece-info {
    flex: 1;
  }
  .piece-type {
    font-weight: 600;
    font-size: 13px;
  }
  .piece-label {
    font-size: 12px;
    color: var(--color-muted);
  }
  .empty-state-small {
    text-align: center;
    padding: 24px;
    color: var(--color-muted);
    font-style: italic;
  }
  .status-banner {
    padding: 12px 16px;
    border-radius: 8px;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 12px;
    font-weight: 500;
  }
  .status-banner.available {
    background: rgba(74, 222, 128, 0.12);
    border: 1px solid rgba(74, 222, 128, 0.3);
    color: #4ade80;
  }
  .status-banner.checked_out {
    background: rgba(251, 191, 36, 0.12);
    border: 1px solid rgba(251, 191, 36, 0.3);
    color: #fbbf24;
  }
  .status-banner.assigned {
    background: rgba(96, 165, 250, 0.12);
    border: 1px solid rgba(96, 165, 250, 0.3);
    color: #60a5fa;
  }
  .breadcrumb {
    margin-bottom: 16px;
    font-size: 14px;
  }
  .breadcrumb a {
    color: var(--color-primary);
    text-decoration: none;
  }
  .breadcrumb a:hover {
    text-decoration: underline;
  }
  .breadcrumb span {
    color: var(--color-muted);
    margin: 0 8px;
  }
  /* Modal form elements */
  .modal-dialog select {
    appearance: none;
    width: 100%;
    padding: 12px 44px 12px 14px;
    border-radius: 12px;
    border: 1px solid var(--color-border);
    background: linear-gradient(135deg, rgba(148, 163, 184, 0.08), rgba(148, 163, 184, 0.02));
    color: var(--color-text);
    font-size: 14px;
    transition: border-color 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
  }
  .modal-dialog select:focus {
    outline: none;
    border-color: var(--color-accent);
    box-shadow: 0 0 0 3px var(--color-accent-soft);
    background: linear-gradient(135deg, rgba(229, 57, 53, 0.12), rgba(148, 163, 184, 0.05));
  }
  .modal-dialog select option {
    background: var(--color-card);
    color: var(--color-text);
    padding: 8px;
  }
</style>

{% set item_type_lower = (item.type or '')|lower %}
{% set status_lower = (item.status or '')|lower %}
{% set viewer_role = (current_user.role or '').lower() if current_user.is_authenticated else '' %}

<div class="breadcrumb">
  <a href="{{ url_for('main.home') }}">Home</a>
  <span>/</span>
  {% if item_type_lower == 'lockbox' %}
    <a href="{{ url_for('inventory.list_lockboxes') }}">Lockboxes</a>
  {% elif item_type_lower == 'key' %}
    <a href="{{ url_for('inventory.list_keys') }}">Keys</a>
  {% elif item_type_lower == 'sign' %}
    <a href="{{ url_for('inventory.list_signs') }}">Signs</a>
  {% endif %}
  <span>/</span>
  <strong>{{ item.label }}</strong>
</div>

<div class="page-header">
  <h1>{{ item.label }}</h1>
  <span class="tag {{ 'ok' if status_lower in ['available', 'assigned'] else 'warn' }}">
    {{ (item.status or 'Unknown').replace('_',' ')|title }}
  </span>
</div>

{% if status_lower == 'checked_out' %}
<div class="status-banner checked_out">
  <strong>Checked Out</strong> - This item is currently in use
</div>
{% elif status_lower == 'assigned' %}
<div class="status-banner assigned">
  <strong>Assigned</strong> - {{ item.assigned_to or 'Unknown' }}
</div>
{% elif status_lower == 'available' %}
<div class="status-banner available">
  <strong>Available</strong> - Ready to use
</div>
{% endif %}

<div class="details-container">
  <!-- Left Column -->
  <div>
    <!-- Item Information Card -->
    <div class="info-card">
      <h2>Item Information</h2>
      <div class="info-grid">
        <div class="info-item">
          <div class="info-label">ID</div>
          <div class="info-value large">{{ item.custom_id or '-' }}</div>
        </div>

        <div class="info-item">
          <div class="info-label">Type</div>
          <div class="info-value">{{ item.type }}</div>
        </div>

        <div class="info-item">
          <div class="info-label">Status</div>
          <div class="info-value">{{ (item.status or 'Unknown').replace('_',' ')|title }}</div>
        </div>

        {% if item.location %}
        <div class="info-item">
          <div class="info-label">Location</div>
          <div class="info-value">{{ item.location }}</div>
        </div>
        {% endif %}

        {% if item.property %}
        <div class="info-item">
          <div class="info-label">Property</div>
          <div class="info-value">
            <a href="{{ url_for('properties.property_detail', property_id=item.property.id) }}">{{ item.property.name }}</a>
          </div>
        </div>
        {% endif %}

        {% if item.property_unit %}
        <div class="info-item">
          <div class="info-label">Unit</div>
          <div class="info-value">{{ item.property_unit.label }}</div>
        </div>
        {% endif %}

        {% if item.address %}
        <div class="info-item">
          <div class="info-label">Property Address</div>
          <div class="info-value">{{ item.address }}</div>
        </div>
        {% endif %}

        {% if item.assigned_to %}
        <div class="info-item">
          <div class="info-label">Assigned To</div>
          <div class="info-value">{{ item.assigned_to }}</div>
        </div>
        {% endif %}

        <!-- Type-Specific Fields -->
        {% if item_type_lower == 'lockbox' %}
          {% if item.code_current %}
          <div class="info-item">
            <div class="info-label">Current Code</div>
            <div class="info-value">{{ item.code_current }}</div>
          </div>
          {% endif %}
          {% if item.code_previous %}
          <div class="info-item">
            <div class="info-label">Previous Code</div>
            <div class="info-value">{{ item.code_previous }}</div>
          </div>
          {% endif %}

        {% elif item_type_lower == 'key' %}
          {% if item.key_hook_number %}
          <div class="info-item">
            <div class="info-label">Key Hook #</div>
            <div class="info-value">{{ item.key_hook_number }}</div>
          </div>
          {% endif %}
          {% if item.keycode %}
          <div class="info-item">
            <div class="info-label">Key Code</div>
            <div class="info-value">{{ item.keycode }}</div>
          </div>
          {% endif %}
          {% if item.master_key %}
          <div class="info-item">
            <div class="info-label">Master Key</div>
            <div class="info-value">
              <a href="{{ url_for('inventory.item_details', item_id=item.master_key.id) }}">
                {{ item.master_key.custom_id or item.master_key.id }} - {{ item.master_key.label }}
              </a>
            </div>
          </div>
          {% endif %}
          <div class="info-item">
            <div class="info-label">Total Copies</div>
            <div class="info-value large">{{ item.total_copies or 0 }}</div>
          </div>
          <div class="info-item">
            <div class="info-label">Available</div>
            <div class="info-value large">{{ available_copies }}</div>
          </div>
          <div class="info-item">
            <div class="info-label">Checked Out</div>
            <div class="info-value large">{{ item.copies_checked_out or 0 }}</div>
          </div>

        {% elif item_type_lower == 'sign' %}
          {% if item.sign_subtype %}
          <div class="info-item">
            <div class="info-label">Sign Type</div>
            <div class="info-value">{{ item.sign_subtype }}</div>
          </div>
          {% endif %}
          {% if item.piece_type %}
          <div class="info-item">
            <div class="info-label">Piece Type</div>
            <div class="info-value">{{ item.piece_type }}</div>
          </div>
          {% endif %}
          {% if item.rider_text %}
          <div class="info-item">
            <div class="info-label">Rider Text</div>
            <div class="info-value">{{ item.rider_text }}</div>
          </div>
          {% endif %}
          {% if item.material %}
          <div class="info-item">
            <div class="info-label">Material</div>
            <div class="info-value">{{ item.material }}</div>
          </div>
          {% endif %}
          {% if item.condition %}
          <div class="info-item">
            <div class="info-label">Condition</div>
            <div class="info-value">{{ item.condition }}</div>
          </div>
          {% endif %}
        {% endif %}

        {% if item.last_action %}
        <div class="info-item">
          <div class="info-label">Last Action</div>
          <div class="info-value">
            {{ item.last_action.replace('_', ' ')|title }}
            {% if item.last_action_at %}
              <br><span class="muted text-small">{{ item.last_action_at.strftime('%Y-%m-%d %H:%M') }}</span>
            {% endif %}
          </div>
        </div>
        {% endif %}
      </div>
    </div>

    <!-- Component Pieces (for Assembled Signs) -->
    {% if component_pieces %}
    <div class="pieces-card" style="margin-top: 20px;">
      <h2>Component Pieces ({{ component_pieces|length }})</h2>
      {% for piece in component_pieces %}
        <div class="piece-item">
          <div class="piece-info">
            <div class="piece-type">{{ piece.piece_type or 'Unknown' }}</div>
            <div class="piece-label">{{ piece.label }} ({{ piece.custom_id }})</div>
            {% if piece.rider_text %}
              <div class="piece-label">Text: "{{ piece.rider_text }}"</div>
            {% endif %}
          </div>
          <div style="display: flex; gap: 8px;">
            <a href="{{ url_for('inventory.item_details', item_id=piece.id) }}" class="btn small">View</a>
            <button class="btn small primary js-swap-piece"
              data-piece-id="{{ piece.id }}"
              data-piece-type="{{ piece.piece_type }}"
              data-piece-label="{{ piece.label }}"
              data-assembled-unit-id="{{ item.id }}">
              Swap
            </button>
          </div>
        </div>
      {% endfor %}
    </div>
    {% endif %}

    <!-- Parent Unit (for Sign Pieces) -->
    {% if parent_unit %}
    <div class="pieces-card" style="margin-top: 20px;">
      <h2>Part of Assembled Unit</h2>
      <div class="piece-item">
        <div class="piece-info">
          <div class="piece-type">{{ parent_unit.label }}</div>
          <div class="piece-label">{{ parent_unit.custom_id }}</div>
        </div>
        <a href="{{ url_for('inventory.item_details', item_id=parent_unit.id) }}" class="btn small">View Unit</a>
      </div>
    </div>
    {% endif %}

    <!-- Active Checkouts -->
    {% if active_checkouts %}
    <div class="checkouts-card" style="margin-top: 20px;">
      <h2>Active Checkouts ({{ active_checkouts|length }})</h2>
      {% for checkout in active_checkouts %}
        <div class="checkout-item">
          <div class="checkout-header">
            <span class="checkout-name">{{ checkout.checked_out_to }}</span>
            {% if checkout.quantity > 1 %}
              <span class="checkout-qty">{{ checkout.quantity }} {{ 'copy' if checkout.quantity == 1 else 'copies' }}</span>
            {% endif %}
          </div>
          <div class="checkout-details">
            {% if checkout.purpose %}
              <div><strong>Purpose:</strong> {{ checkout.purpose }}</div>
            {% endif %}
            {% if checkout.address %}
              <div><strong>Address:</strong> {{ checkout.address }}</div>
            {% endif %}
            {% if checkout.assignment_type %}
              <div><strong>Type:</strong> {{ checkout.assignment_type|title }}</div>
            {% endif %}
            {% if checkout.expected_return_date %}
              <div><strong>Expected Return:</strong> {{ checkout.expected_return_date.strftime('%Y-%m-%d') }}</div>
            {% endif %}
            <div><strong>Checked Out:</strong> {{ checkout.checked_out_at.strftime('%Y-%m-%d %H:%M') }}
              {% if checkout.checked_out_by %}by {{ checkout.checked_out_by.name }}{% endif %}
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
    {% endif %}

    <!-- Child Keys (if this is a master key) -->
    {% if item_type_lower == 'key' and child_keys %}
    <div class="checkouts-card" style="margin-top: 20px;">
      <h2>Keys Using This as Master ({{ child_keys|length }})</h2>
      <table style="width: 100%; border-collapse: collapse;">
        <thead>
          <tr>
            <th style="text-align: left; padding: 8px; border-bottom: 1px solid var(--color-border);">ID</th>
            <th style="text-align: left; padding: 8px; border-bottom: 1px solid var(--color-border);">Label</th>
            <th style="text-align: left; padding: 8px; border-bottom: 1px solid var(--color-border);">Status</th>
            <th style="text-align: left; padding: 8px; border-bottom: 1px solid var(--color-border);">Location</th>
            <th style="text-align: left; padding: 8px; border-bottom: 1px solid var(--color-border);">Copies</th>
            <th style="text-align: left; padding: 8px; border-bottom: 1px solid var(--color-border);">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for child in child_keys %}
          <tr>
            <td style="padding: 8px; border-bottom: 1px solid var(--color-border);"><code>{{ child.custom_id or child.id }}</code></td>
            <td style="padding: 8px; border-bottom: 1px solid var(--color-border);">{{ child.label }}</td>
            <td style="padding: 8px; border-bottom: 1px solid var(--color-border);">
              <span class="tag {% if child.status == 'available' %}ok{% elif child.status == 'checked_out' %}warn{% elif child.status == 'assigned' %}info{% endif %}">
                {{ child.status.replace('_', ' ').title() }}
              </span>
            </td>
            <td style="padding: 8px; border-bottom: 1px solid var(--color-border);">{{ child.location or '-' }}</td>
            <td style="padding: 8px; border-bottom: 1px solid var(--color-border);">
              {% if child.total_copies %}
                {{ (child.total_copies - (child.copies_checked_out or 0)) }}/{{ child.total_copies }}
              {% else %}
                -
              {% endif %}
            </td>
            <td style="padding: 8px; border-bottom: 1px solid var(--color-border);">
              <a href="{{ url_for('inventory.item_details', item_id=child.id) }}" class="btn small">View</a>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% endif %}

    <!-- Activity History -->
    <div class="history-card" style="margin-top: 20px;">
      <h2>Activity History</h2>
      {% if activity_logs %}
        {% for log in activity_logs %}
          <div class="activity-item">
            <div class="activity-header">
              <span class="activity-action">{{ log.action.replace('_', ' ')|title }}</span>
              <span class="activity-time">{{ log.created_at.strftime('%Y-%m-%d %H:%M') }}</span>
            </div>
            {% if log.summary %}
              <div class="activity-summary">{{ log.summary }}</div>
            {% endif %}
            {% if log.user %}
              <div class="activity-user">By: {{ log.user.name }}</div>
            {% endif %}
          </div>
        {% endfor %}
      {% else %}
        <div class="empty-state-small">No activity recorded</div>
      {% endif %}
    </div>
  </div>

  <!-- Right Column - Actions -->
  <div>
    <div class="actions-card">
      <h2>Quick Actions</h2>
      <div class="actions-grid">
        {% if can_checkout %}
          <button class="btn primary js-checkout-action" type="button"
            data-item-id="{{ item.id }}"
            data-item-type="{{ item_type_lower }}"
            data-label="{{ item.label|e }}"
            data-location="{{ item.location|default('', true)|e }}"
            data-address="{{ item.address|default('', true)|e }}"
            data-assigned="{{ item.assigned_to|default('', true)|e }}"
            data-available="{{ available_copies }}"
            data-action="{% if item_type_lower == 'lockbox' %}{{ url_for('inventory.checkout_lockbox', item_id=item.id) }}{% elif item_type_lower == 'key' %}{{ url_for('inventory.checkout_key', item_id=item.id) }}{% elif item_type_lower == 'sign' and has_endpoint('inventory.checkout_sign') %}{{ url_for('inventory.checkout_sign', item_id=item.id) }}{% else %}#{% endif %}"
            data-property-id="{{ item.property_id or '' }}"
            data-property-unit-id="{{ item.property_unit_id or '' }}"
            data-redirect="{% if item_type_lower == 'lockbox' %}{{ url_for('inventory.list_lockboxes') }}{% elif item_type_lower == 'key' %}{{ url_for('inventory.list_keys') }}{% elif item_type_lower == 'sign' and has_endpoint('inventory.list_signs') %}{{ url_for('inventory.list_signs') }}{% else %}#{% endif %}"
            data-redirect-anchor="checkout-{{ item.id }}">
            Check Out
          </button>
        {% endif %}

        {% if can_checkin %}
          <button class="btn primary js-checkin-action" type="button"
            data-item-id="{{ item.id }}"
            data-item-type="{{ item_type_lower }}"
            data-label="{{ item.label|e }}"
            data-location="{{ item.location|default('', true)|e }}"
            data-address="{{ item.address|default('', true)|e }}"
            data-action="{% if item_type_lower == 'lockbox' %}{{ url_for('inventory.checkin_lockbox', item_id=item.id) }}{% elif item_type_lower == 'key' %}{{ url_for('inventory.checkin_key', item_id=item.id) }}{% else %}#{% endif %}"
            data-redirect="{% if item_type_lower == 'lockbox' %}{{ url_for('inventory.list_lockboxes') }}{% elif item_type_lower == 'key' %}{{ url_for('inventory.list_keys') }}{% elif item_type_lower == 'sign' and has_endpoint('inventory.list_signs') %}{{ url_for('inventory.list_signs') }}{% else %}#{% endif %}"
            data-redirect-anchor="checkin-{{ item.id }}">
            Check In
          </button>
        {% endif %}

        {% if can_assign %}
          <button class="btn js-assign-action" type="button"
            data-item-id="{{ item.id }}"
            data-item-type="{{ item_type_lower }}"
            data-label="{{ item.label|e }}"
            data-action="{% if item_type_lower == 'lockbox' %}{{ url_for('inventory.assign_lockbox', item_id=item.id) }}{% elif item_type_lower == 'key' %}{{ url_for('inventory.assign_key', item_id=item.id) }}{% else %}#{% endif %}"
            data-property-id="{{ item.property_id or '' }}"
            data-property-unit-id="{{ item.property_unit_id or '' }}"
            data-available="{{ available_copies }}"
            data-redirect="{% if item_type_lower == 'lockbox' %}{{ url_for('inventory.list_lockboxes') }}{% elif item_type_lower == 'key' %}{{ url_for('inventory.list_keys') }}{% elif item_type_lower == 'sign' and has_endpoint('inventory.list_signs') %}{{ url_for('inventory.list_signs') }}{% else %}#{% endif %}"
            data-redirect-anchor="assign-{{ item.id }}">
            Assign
          </button>
        {% endif %}

        {% if item_type_lower == 'key' and (item.total_copies or 0) > 0 %}
          <button class="btn js-adjust-qty-action" type="button"
            data-item-id="{{ item.id }}"
            data-action="{{ url_for('inventory.adjust_key_quantity', item_id=item.id) }}"
            data-redirect="{{ url_for('inventory.list_keys') }}"
            data-redirect-anchor="adjust-qty-{{ item.id }}"
            data-label="{{ item.label|e }}"
            data-total="{{ item.total_copies or 0 }}">
            Adjust Quantity
          </button>
        {% endif %}

        {% if item_type_lower == 'sign' and item.sign_subtype == 'Assembled Unit' %}
          <form method="post" action="{{ url_for('inventory.disassemble_sign', item_id=item.id) }}" onsubmit="return confirm('Disassemble this sign? Pieces will become available individually.');">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            <button class="btn" type="submit">Disassemble</button>
          </form>
        {% endif %}

        {% if viewer_role == 'admin' %}
          <button class="btn js-edit-action" type="button"
            data-item-id="{{ item.id }}"
            data-action="{% if item_type_lower == 'lockbox' %}{{ url_for('inventory.edit_lockbox', item_id=item.id) }}{% elif item_type_lower == 'key' %}{{ url_for('inventory.edit_key', item_id=item.id) }}{% elif item_type_lower == 'sign' and has_endpoint('inventory.edit_sign') %}{{ url_for('inventory.edit_sign', item_id=item.id) }}{% else %}#{% endif %}"
            data-label="{{ item.label|e }}"
            data-location="{{ item.location|default('', true)|e }}"
            data-address="{{ item.address|default('', true)|e }}"
            data-status="{{ item.status or '' }}"
            data-assigned-to="{{ item.assigned_to|default('', true)|e }}"
            data-property-id="{{ item.property_id or '' }}"
            data-property-unit-id="{{ item.property_unit_id or '' }}"
            data-total="{{ item.total_copies or 0 }}"
            data-key-hook="{{ item.key_hook_number|default('', true)|e }}"
            data-keycode="{{ item.keycode|default('', true)|e }}"
            data-sign-subtype="{{ item.sign_subtype or '' }}"
            data-piece-type="{{ item.piece_type or '' }}"
            data-rider-text="{{ item.rider_text|default('', true)|e }}"
            data-material="{{ item.material|default('', true)|e }}"
            data-condition="{{ item.condition|default('', true)|e }}"
            data-redirect="{% if item_type_lower == 'lockbox' %}{{ url_for('inventory.list_lockboxes') }}{% elif item_type_lower == 'key' %}{{ url_for('inventory.list_keys') }}{% elif item_type_lower == 'sign' and has_endpoint('inventory.list_signs') %}{{ url_for('inventory.list_signs') }}{% else %}#{% endif %}"
            data-redirect-anchor="edit-{{ item.id }}">
            Edit Details
          </button>

          {% if not (item.sign_subtype == 'Assembled Unit' and component_pieces) %}
            <form method="post" action="{{ url_for('inventory.delete_' + item_type_lower, item_id=item.id) }}" onsubmit="return confirm('Delete {{ item.label }}? This cannot be undone.');">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
              <button class="btn danger" type="submit">Delete</button>
            </form>
          {% endif %}
        {% endif %}
      </div>
    </div>

    <!-- Checkout History -->
    {% if checkout_history %}
    <div class="checkouts-card" style="margin-top: 20px;">
      <h2>Recent Returns</h2>
      {% for checkout in checkout_history %}
        <div class="checkout-item" style="background: rgba(96, 165, 250, 0.04);">
          <div class="checkout-header">
            <span class="checkout-name">{{ checkout.checked_out_to }}</span>
            {% if checkout.quantity > 1 %}
              <span class="checkout-qty">{{ checkout.quantity }}</span>
            {% endif %}
          </div>
          <div class="checkout-details">
            <div><strong>Returned:</strong> {{ checkout.checked_in_at.strftime('%Y-%m-%d %H:%M') if checkout.checked_in_at else '-' }}</div>
            <div><strong>Duration:</strong>
              {% if checkout.checked_out_at and checkout.checked_in_at %}
                {{ ((checkout.checked_in_at - checkout.checked_out_at).days) }} days
              {% endif %}
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
    {% endif %}
  </div>
</div>

<div id="item-action-modal" class="modal-root" aria-hidden="true">
  <div class="modal-backdrop" data-modal-cancel></div>
  <div class="modal-dialog" role="dialog" aria-modal="true" aria-labelledby="item-action-modal-title">
    <form id="item-action-modal-form">
      <h3 id="item-action-modal-title">Action</h3>
      <div id="item-action-modal-body" class="modal-body"></div>
      <div class="modal-actions">
        <button type="button" class="btn" data-modal-cancel>Cancel</button>
        <button type="submit" class="btn primary" id="item-action-modal-submit">Submit</button>
      </div>
    </form>
  </div>
</div>

<!-- Swap Piece Modal -->
<div id="swap-piece-modal" class="modal-root" aria-hidden="true">
  <div class="modal-backdrop" onclick="closeSwapModal()"></div>
  <div class="modal-dialog" role="dialog" aria-modal="true">
    <form id="swap-piece-form" method="post">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
      <h3 id="swap-modal-title">Swap Component Piece</h3>
      <div class="modal-body">
        <p>Current piece: <strong id="current-piece-label"></strong></p>
        <div class="form-field">
          <label for="new-piece-id">Replace with:</label>
          <select id="new-piece-id" name="new_piece_id" required>
            <option value="">Loading available pieces...</option>
          </select>
        </div>
      </div>
      <div class="modal-actions">
        <button type="button" class="btn" onclick="closeSwapModal()">Cancel</button>
        <button type="submit" class="btn primary">Swap Piece</button>
      </div>
    </form>
  </div>
</div>

<script>
  // Swap piece functionality
  const swapModal = document.getElementById('swap-piece-modal');
  const swapForm = document.getElementById('swap-piece-form');
  const newPieceSelect = document.getElementById('new-piece-id');
  const currentPieceLabel = document.getElementById('current-piece-label');
  const swapModalTitle = document.getElementById('swap-modal-title');

  function closeSwapModal() {
    swapModal.classList.remove('show');
    document.body.classList.remove('modal-open');
    swapForm.reset();
  }

  async function loadAvailablePieces(pieceType, currentPieceId) {
    try {
      const response = await fetch(`/inventory/api/available-pieces?piece_type=${encodeURIComponent(pieceType)}&exclude=${currentPieceId}`);
      if (!response.ok) throw new Error('Failed to load pieces');
      const pieces = await response.json();

      newPieceSelect.innerHTML = '<option value="">-- Select a piece --</option>';
      pieces.forEach(piece => {
        const option = document.createElement('option');
        option.value = piece.id;
        const riderText = piece.rider_text ? ` - "${piece.rider_text}"` : '';
        option.textContent = `${piece.custom_id} - ${piece.label}${riderText}`;
        newPieceSelect.appendChild(option);
      });

      if (pieces.length === 0) {
        newPieceSelect.innerHTML = '<option value="">No available pieces of this type</option>';
      }
    } catch (error) {
      console.error('Error loading pieces:', error);
      newPieceSelect.innerHTML = '<option value="">Error loading pieces</option>';
    }
  }

  document.querySelectorAll('.js-swap-piece').forEach(button => {
    button.addEventListener('click', function() {
      const pieceId = this.dataset.pieceId;
      const pieceType = this.dataset.pieceType;
      const pieceLabel = this.dataset.pieceLabel;
      const assembledUnitId = this.dataset.assembledUnitId;

      currentPieceLabel.textContent = pieceLabel;
      swapModalTitle.textContent = `Swap ${pieceType}`;
      swapForm.action = `/inventory/signs/${assembledUnitId}/swap-piece/${pieceId}`;

      loadAvailablePieces(pieceType, pieceId);

      swapModal.classList.add('show');
      document.body.classList.add('modal-open');
    });
  });

  swapForm.addEventListener('submit', function(e) {
    const selectedPiece = newPieceSelect.value;
    if (!selectedPiece) {
      e.preventDefault();
      alert('Please select a piece to swap with');
    }
  });

  window.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && swapModal.classList.contains('show')) {
      closeSwapModal();
    }
  });
</script>

<script>
  window.kbmItemDetails = {
    itemType: "{{ item_type_lower }}",
    statusOptions: {{ status_options|default([])|tojson }},
    statusOptionsLower: {{ status_options_lower|default([])|tojson }},
    propertyOptions: {{ property_select_options|default([])|tojson }},
    propertyMap: {{ property_map|default({})|tojson }},
    propertyUnits: {{ property_units_map|default({})|tojson }},
    pieceTypes: {{ piece_types|default([])|tojson }},
    conditionOptions: {{ condition_options|default([])|tojson }},
    availableCopies: {{ available_copies|default(0) }},
    activeCheckoutsUrl: {% if item_type_lower == 'key' %}"{{ url_for('inventory.get_key_active_checkouts', item_id=item.id) }}"{% else %}null{% endif %}
  };
</script>
<script src="{{ url_for('static', filename='js/item_actions.js') }}"></script>

{% endblock %}
