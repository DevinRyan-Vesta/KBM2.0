{% extends "base.html" %}
{% block title %}Add Key - KBM{% endblock %}

{% block content %}
<style>
  .form-card .select-field {
    position: relative;
  }
  .form-card .select-field select {
    appearance: none;
    width: 100%;
    padding: 12px 44px 12px 14px;
    border-radius: 12px;
    border: 1px solid var(--color-border);
    background: linear-gradient(135deg, rgba(148, 163, 184, 0.08), rgba(148, 163, 184, 0.02));
    color: var(--color-text);
    font-size: 14px;
    transition: border-color 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
  }
  .form-card .select-field select:focus {
    outline: none;
    border-color: var(--color-accent);
    box-shadow: 0 0 0 3px var(--color-accent-soft);
    background: linear-gradient(135deg, rgba(229, 57, 53, 0.12), rgba(148, 163, 184, 0.05));
  }
  .form-card .select-field::after {
    content: "\25BC";
    position: absolute;
    top: 50%;
    right: 14px;
    transform: translateY(-50%);
    font-size: 12px;
    pointer-events: none;
    color: var(--color-muted);
  }
  .form-card .select-field select option {
    background: var(--color-card);
    color: var(--color-text);
    padding: 8px;
  }
</style>

<div class="form-shell">
  <div class="page-header">
    <h1>Add New Key</h1>
  </div>

  <div class="card form-card">
    <form method="post" action="{{ url_for('inventory.add_key') }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
      <div class="form-grid two-column">
        <div class="form-field">
          <label for="label">Label *</label>
          <input type="text" id="label" name="label" placeholder="e.g., KEY-101A" required>
        </div>

        <div class="form-field select-field">
          <label for="property_id">Property</label>
          <select id="property_id" name="property_id">
            <option value="">-- Select Property --</option>
            {% for prop in properties %}
              <option value="{{ prop.id }}">{{ prop.display }}</option>
            {% endfor %}
          </select>
          <small class="muted">Optional. Address is automatically filled when left blank.</small>
        </div>

        <div class="form-field select-field" id="property-unit-wrapper" style="display: none;">
          <label for="property_unit_id">Property Unit</label>
          <select id="property_unit_id" name="property_unit_id">
            <option value="">-- None --</option>
          </select>
          <small class="muted">Visible when the selected property has units.</small>
        </div>

        <div class="form-field">
          <label for="address">Address</label>
          <input type="text" id="address" name="address" placeholder="Property address">
        </div>

        <div class="form-field">
          <label for="location">Key Box Location</label>
          <input type="text" id="location" name="location" placeholder="e.g., Main Office">
        </div>

        <div class="form-field">
          <label for="key_hook_number">Key Hook #</label>
          <input type="text" id="key_hook_number" name="key_hook_number" placeholder="Hook number in key box">
        </div>

        <div class="form-field">
          <label for="keycode">Key Code</label>
          <input type="text" id="keycode" name="keycode" placeholder="5-digit cut code (if known)">
        </div>

        <div class="form-field">
          <label for="total_copies">Total Copies *</label>
          <input type="number" id="total_copies" name="total_copies" min="0" value="1" required>
        </div>

        <div class="form-field select-field">
          <label for="master_key_id">Master Key</label>
          <select id="master_key_id" name="master_key_id">
            <option value="">-- None --</option>
            {% for key in master_keys %}
              <option value="{{ key.id }}">{{ key.custom_id or key.id }} - {{ key.label }}</option>
            {% endfor %}
          </select>
          <small class="muted">Optional. Link this key to a master key.</small>
        </div>
      </div>

      <div class="toolbar spaced">
        <button type="submit" class="btn primary">Add Key</button>
        <a href="{{ url_for('inventory.list_keys') }}" class="btn ghost">Cancel</a>
      </div>
    </form>
  </div>
</div>

<script>
  (function() {
    const propertyLookup = {{ property_lookup|default({})|tojson }};
    const propertyUnits = {{ property_units_map|default({})|tojson }};
    const propertySelect = document.getElementById('property_id');
    const propertyUnitWrapper = document.getElementById('property-unit-wrapper');
    const propertyUnitSelect = document.getElementById('property_unit_id');
    const addressInput = document.getElementById('address');

    function populateUnits(propertyId, selectedUnitId) {
      const units = propertyUnits[propertyId] || [];
      propertyUnitSelect.innerHTML = '';
      const defaultOption = document.createElement('option');
      defaultOption.value = '';
      defaultOption.textContent = '-- None --';
      propertyUnitSelect.appendChild(defaultOption);
      units.forEach((unit) => {
        const opt = document.createElement('option');
        opt.value = unit.id;
        opt.textContent = unit.label;
        if (selectedUnitId && selectedUnitId === unit.id) {
          opt.selected = true;
        }
        propertyUnitSelect.appendChild(opt);
      });
      propertyUnitWrapper.style.display = units.length ? 'block' : 'none';
    }

    function handlePropertyChange() {
      const selectedId = propertySelect.value || '';
      const match = propertyLookup[selectedId] || null;
      if (match && !addressInput.value) {
        const addressParts = [match.address_line1, match.city, match.state, match.postal_code];
        addressInput.value = addressParts.filter(Boolean).join(', ');
      }
      populateUnits(selectedId, '');
    }

    propertySelect.addEventListener('change', handlePropertyChange);
    handlePropertyChange();
  })();
</script>
{% endblock %}
