{% extends "base.html" %}
{% block title %}{{ page_title }} - KBM{% endblock %}

{% block content %}
<style>
  .form-card select {
    appearance: none;
    width: 100%;
    padding: 12px 44px 12px 14px;
    border-radius: 12px;
    border: 1px solid var(--color-border);
    background: linear-gradient(135deg, rgba(148, 163, 184, 0.08), rgba(148, 163, 184, 0.02));
    color: var(--color-text);
    font-size: 14px;
    transition: border-color 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
  }
  .form-card select:focus {
    outline: none;
    border-color: var(--color-accent);
    box-shadow: 0 0 0 3px var(--color-accent-soft);
    background: linear-gradient(135deg, rgba(229, 57, 53, 0.12), rgba(148, 163, 184, 0.05));
  }
  .form-card select option {
    background: var(--color-card);
    color: var(--color-text);
    padding: 8px;
  }
  .form-field {
    position: relative;
  }
  .form-field:has(select)::after {
    content: "\25BC";
    position: absolute;
    top: 38px;
    right: 14px;
    font-size: 12px;
    pointer-events: none;
    color: var(--color-muted);
  }
</style>

<div class="form-shell">
  <div class="page-header">
    <h1>{{ page_title }}</h1>
  </div>

  <div class="card form-card">
    <form method="post" action="{{ form_action }}">
      <div class="form-grid two-column">
        <div class="form-field">
          <label for="name">Name *</label>
          <input type="text" id="name" name="name" value="{{ contact.name if contact else '' }}" required>
        </div>

        <div class="form-field">
          <label for="contact_type">Contact Type *</label>
          <select id="contact_type" name="contact_type" required>
            <option value="" {% if not contact %}selected{% endif %} disabled>Select contact type</option>
            {% for type in contact_types %}
              {% set label = type.replace('_', ' ')|title %}
              <option value="{{ type }}" {% if contact and (contact.contact_type or '').lower() == type %}selected{% endif %}>{{ label }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="form-field">
          <label for="company">Company</label>
          <input type="text" id="company" name="company" value="{{ contact.company if contact else '' }}" placeholder="Business or organization">
        </div>

        <div class="form-field">
          <label for="email">Email</label>
          <input type="email" id="email" name="email" value="{{ contact.email if contact else '' }}">
        </div>

        <div class="form-field">
          <label for="phone">Phone</label>
          <input type="text" id="phone" name="phone" value="{{ contact.phone if contact else '' }}" placeholder="(555) 555-5555">
        </div>

        <div class="form-field" id="staff-user-field">
          <label for="user_id">Linked User (Staff)</label>
          <select id="user_id" name="user_id">
            <option value="">-- No Linked User --</option>
            {% for user in staff_users %}
              <option value="{{ user.id }}" {% if contact and contact.user_id == user.id %}selected{% endif %}>{{ user.name }} ({{ user.email }})</option>
            {% endfor %}
          </select>
          <small class="muted">Optional link to an existing staff account.</small>
        </div>
      </div>

      <div class="form-field">
        <label for="notes">Notes</label>
        <textarea id="notes" name="notes" rows="4" placeholder="Additional information">{{ contact.notes if contact else '' }}</textarea>
      </div>

      <div class="toolbar spaced">
        <button type="submit" class="btn primary">{{ submit_label }}</button>
        <a class="btn ghost" href="{{ url_for('contacts.list_contacts') }}">Cancel</a>
      </div>
    </form>
  </div>
</div>

<script>
  (function() {
    const contactTypeSelect = document.getElementById('contact_type');
    const staffField = document.getElementById('staff-user-field');

    function toggleStaffField() {
      const value = contactTypeSelect.value;
      if (value === 'staff') {
        staffField.style.display = 'block';
      } else {
        staffField.style.display = 'none';
        const select = staffField.querySelector('select');
        if (select) {
          select.value = '';
        }
      }
    }

    toggleStaffField();
    contactTypeSelect.addEventListener('change', toggleStaffField);
  })();
</script>
{% endblock %}

