{% extends "base.html" %}
{% block title %}Map Columns - Import {{ item_type }} - KBM{% endblock %}

{% block content %}
<div class="form-shell">
  <div class="page-header">
    <h1>Map Columns - Import {{ item_type }}</h1>
    <p class="muted">Match your file columns to database fields</p>
  </div>

  <div class="card form-card">
    <form method="post">
      <div class="info-box" style="margin-bottom: 20px; padding: 15px; background: rgba(74, 222, 128, 0.08); border-radius: 8px;">
        <p style="margin: 0;"><strong>File uploaded successfully!</strong> Found {{ import_data.total_rows }} rows.</p>
        <p style="margin: 5px 0 0 0;">Map your file columns to the corresponding database fields below.</p>
      </div>

      <h3>Column Mapping</h3>
      <div class="mapping-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
        {% for field_name, field_config in fields.items() %}
          <div class="form-field">
            <label for="map_{{ field_name }}">
              {{ field_config.name }}
              {% if field_config.required %}<span style="color: var(--color-danger);">*</span>{% endif %}
            </label>
            <select id="map_{{ field_name }}" name="map_{{ field_name }}" {% if field_config.required %}required{% endif %}>
              <option value="">-- Select Column --</option>
              {% for header in import_data.headers %}
                <option value="{{ header }}"
                  {% if header.lower().replace(' ', '_').replace('-', '_') == field_name or
                        header.lower() == field_config.name.lower() or
                        header.lower().replace(' ', '') == field_config.name.lower().replace(' ', '') %}
                    selected
                  {% endif %}>
                  {{ header }}
                </option>
              {% endfor %}
            </select>
            {% if field_config.get('default') %}
              <small class="muted">Default: {{ field_config.default }}</small>
            {% endif %}
          </div>
        {% endfor %}
      </div>

      <h3>Preview (First 5 Rows)</h3>
      <div style="overflow-x: auto; margin-bottom: 20px;">
        <table class="preview-table" style="width: 100%; border-collapse: collapse;">
          <thead>
            <tr style="background: #f5f5f5;">
              {% for header in import_data.headers[:10] %}
                <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">{{ header }}</th>
              {% endfor %}
              {% if import_data.headers|length > 10 %}
                <th style="padding: 10px; border: 1px solid #ddd;">...</th>
              {% endif %}
            </tr>
          </thead>
          <tbody>
            {% for row in import_data.rows[:5] %}
              <tr>
                {% for header in import_data.headers[:10] %}
                  <td style="padding: 10px; border: 1px solid #ddd;">{{ row.get(header, '') }}</td>
                {% endfor %}
                {% if import_data.headers|length > 10 %}
                  <td style="padding: 10px; border: 1px solid #ddd;">...</td>
                {% endif %}
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <div class="toolbar spaced">
        <button type="submit" class="btn primary">Continue to Preview</button>
        <a class="btn ghost" href="{{ url_for('inventory.import_keys') }}">Start Over</a>
      </div>
    </form>
  </div>
</div>

<style>
  .mapping-grid {
    max-width: 1000px;
  }
  .info-box strong {
    color: var(--color-text);
  }
</style>
{% endblock %}
