{% extends "base.html" %}
{% block title %}Lockboxes - KBM{% endblock %}

{% block content %}
<style>
  .bulkbar {
    display: none;
    align-items: center;
    gap: 12px;
    padding: 10px 14px;
    border-radius: 12px;
    border: 1px solid var(--color-border);
    background: rgba(229, 57, 53, 0.08);
    color: var(--color-text);
    margin-bottom: 18px;
  }
  .bulkbar.show { display: flex; }
  .select-col { width: 40px; }
  .codes { display: flex; gap: 12px; align-items: flex-start; }
  .code-chip { display: inline-flex; flex-direction: column; gap: 4px; }
  .code-chip span {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 10px;
    border-radius: 10px;
    font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
    font-size: 13px;
  }
  .code-chip span.current { background: rgba(229, 57, 53, 0.18); color: #ffb4b4; }
  .code-chip span.previous { background: rgba(148, 163, 184, 0.12); color: var(--color-muted); }
  .code-chip .label { font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; }

  .row-buttons { display: flex; flex-wrap: wrap; gap: 8px; }
  .actions-col { width: 360px; }

  /* Export dropdown menu */
  .dropdown-menu {
    position: absolute;
    background: var(--color-card);
    border: 1px solid var(--color-border);
    border-radius: 8px;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
    z-index: 1000;
    min-width: 150px;
  }
  .dropdown-menu a {
    display: block;
    padding: 10px 14px;
    color: var(--color-text);
    text-decoration: none;
    border-bottom: 1px solid var(--color-border);
    transition: background 0.2s ease;
  }
  .dropdown-menu a:last-child {
    border-bottom: none;
  }
  .dropdown-menu a:hover {
    background: rgba(229, 57, 53, 0.12);
    color: var(--color-accent);
  }
</style>

{% set status_options = status_options or ['available', 'assigned', 'checked_out', 'maintenance', 'retired'] %}

<div class="page-header">
  <h1>Lockboxes</h1>
  <div class="toolbar">
    <form method="get" class="searchbar" action="{{ url_for('inventory.list_lockboxes') }}">
      <input type="text" name="q" placeholder="Search ID, label, address, code..." value="{{ q or '' }}">
      <button class="btn small" type="submit">Search</button>
      {% if q %}
        <a class="btn small" href="{{ url_for('inventory.list_lockboxes') }}">Clear</a>
      {% endif %}
    </form>
    <div class="btn-group">
      <button type="button" class="btn small" onclick="toggleFilters()">Filters ▾</button>
      <button type="button" class="btn small" onclick="showExportMenu(event, 'lockboxes')">Export ▾</button>
      <a class="btn small" href="{{ url_for('inventory.import_lockboxes') }}">Import</a>
      <a class="btn primary" href="{{ url_for('inventory.add_lockbox') }}">Add Lockbox</a>
    </div>
  </div>
</div>

<!-- Advanced Filters -->
<div id="advanced-filters" class="card" style="display: {% if filter_status or filter_property or filter_assigned %}block{% else %}none{% endif %}; margin-bottom: 20px;">
  <form method="get" action="{{ url_for('inventory.list_lockboxes') }}" style="display: flex; gap: 12px; flex-wrap: wrap; align-items: flex-end;">
    <input type="hidden" name="q" value="{{ q or '' }}">

    <div class="form-field" style="margin: 0; flex: 1; min-width: 180px;">
      <label for="filter-status" style="font-size: 13px; margin-bottom: 4px;">Status</label>
      <select name="status" id="filter-status" style="width: 100%;">
        <option value="">All Statuses</option>
        {% for status in status_options %}
        <option value="{{ status }}" {% if filter_status and filter_status.lower() == status.lower() %}selected{% endif %}>
          {{ status.replace('_', ' ').title() }}
        </option>
        {% endfor %}
      </select>
    </div>

    <div class="form-field" style="margin: 0; flex: 1; min-width: 200px;">
      <label for="filter-property" style="font-size: 13px; margin-bottom: 4px;">Property</label>
      <select name="property" id="filter-property" style="width: 100%;">
        {% for prop in property_select_options %}
        <option value="{{ prop[0] }}" {% if filter_property and filter_property == prop[0] %}selected{% endif %}>
          {{ prop[1] }}
        </option>
        {% endfor %}
      </select>
    </div>

    <div class="form-field" style="margin: 0; flex: 1; min-width: 160px;">
      <label for="filter-assigned" style="font-size: 13px; margin-bottom: 4px;">Assignment</label>
      <select name="assigned" id="filter-assigned" style="width: 100%;">
        <option value="">All Items</option>
        <option value="assigned" {% if filter_assigned == 'assigned' %}selected{% endif %}>Assigned</option>
        <option value="unassigned" {% if filter_assigned == 'unassigned' %}selected{% endif %}>Unassigned</option>
      </select>
    </div>

    <div style="display: flex; gap: 8px;">
      <button type="submit" class="btn small primary">Apply Filters</button>
      {% if filter_status or filter_property or filter_assigned %}
      <a href="{{ url_for('inventory.list_lockboxes', q=q or '') }}" class="btn small ghost">Clear Filters</a>
      {% endif %}
    </div>
  </form>
</div>

<div id="export-menu" class="dropdown-menu" style="display: none;">
  <a href="#" onclick="exportData(event, 'csv')">Export as CSV</a>
  <a href="#" onclick="exportData(event, 'excel')">Export as Excel</a>
  <a href="#" onclick="exportData(event, 'pdf')">Export as PDF</a>
</div>

<!-- Bulk Actions Toolbar -->
<div class="bulkbar" id="bulk-toolbar">
  <input type="checkbox" id="select-all-checkbox" onclick="toggleSelectAll(this)" style="margin: 0;">
  <span id="bulk-count">0 selected</span>
  <select id="bulk-action" class="form-control" style="max-width: 200px;">
    <option value="">-- Select Action --</option>
    <option value="delete">Delete Selected</option>
    <option value="change-status">Change Status</option>
    <option value="assign">Assign To...</option>
  </select>
  <button type="button" class="btn small primary" onclick="executeBulkAction()">Execute</button>
  <button type="button" class="btn small ghost" onclick="clearSelection()">Cancel</button>
</div>

<div class="card table-card">
  {% set viewer_role = (current_user.role or '').lower() if current_user.is_authenticated else '' %}
  {% if lockboxes %}
    <table>
      <thead>
        <tr>
          <th class="select-col"><input type="checkbox" id="th-select-all" onclick="toggleSelectAll(this)" style="margin: 0;"></th>
          <th>Label</th>
          <th>Location</th>
          <th>Address</th>
          <th>Codes</th>
          <th>Supra ID</th>
          <th>Status</th>
          <th>Assigned To</th>
          <th>Last Action</th>
          <th class="actions-col">Actions</th>
        </tr>
      </thead>
            <tbody>
        {% for lb in lockboxes %}
          {% set st_lower = (lb.status or '')|lower %}
          <tr data-item-id="{{ lb.id }}" data-item-label="{{ lb.label }}">
            <td class="select-col">
              <input type="checkbox" class="item-checkbox" value="{{ lb.id }}" onchange="updateBulkToolbar()" style="margin: 0;">
            </td>
            <td>
              <div><strong><a href="{{ url_for('inventory.item_details', item_id=lb.id) }}" style="color: inherit; text-decoration: none;">{{ lb.label }}</a></strong></div>
              {% if lb.custom_id %}
                <div class="muted text-small">{{ lb.custom_id }}</div>
              {% endif %}
            </td>
            <td>
              {{ lb.location or '-' }}
            </td>
            <td>
              {% if lb.property %}
                <div><strong>{{ lb.property.name }}</strong></div>
                {% if lb.property.address_line1 %}
                  <div class="muted text-small">
                    {{ lb.property.address_line1 }}
                    {% if lb.property.city %}, {{ lb.property.city }}{% endif %}
                    {% if lb.property.state %}, {{ lb.property.state }}{% endif %}
                  </div>
                {% endif %}
              {% else %}
                <span class="muted">-</span>
              {% endif %}
            </td>
            <td>
              <div class="codes">
                <div class="code-chip">
                  <span class="muted text-small label">Current</span>
                  <span class="current">{{ lb.code_current or '-' }}</span>
                </div>
                <div class="code-chip">
                  <span class="muted text-small label">Previous</span>
                  <span class="previous">{{ lb.code_previous or '-' }}</span>
                </div>
              </div>
            </td>
            <td>
              {{ lb.supra_id or '-' }}
            </td>
            <td>
              {% set st_lower = (lb.status or 'Unknown')|lower %}
              <span class="tag {{ 'ok' if st_lower in ['available', 'assigned'] else 'warn' }}">
                {{ (lb.status or 'Unknown').replace('_',' ')|title }}
              </span>
            </td>
            <td>{{ lb.assigned_to or '-' }}</td>
            <td>
              {% if lb.last_action %}
                <div class="muted">
                  {{ lb.last_action.replace('_', ' ')|title }}
                  {% if lb.last_action_at %}
                    <br><span class="text-small">{{ lb.last_action_at.strftime('%Y-%m-%d %H:%M') }}</span>
                  {% endif %}
                </div>
              {% else %}
                <span class="muted">-</span>
              {% endif %}
            </td>
            <td>
              <div class="row-buttons">
                {% if viewer_role in ['admin', 'owner', 'staff'] %}
                  <button class="btn xsmall" onclick="openItemActionModal({{ lb.id }}, 'edit')">Edit</button>

                  {% if st_lower == 'available' %}
                    <button class="btn xsmall" onclick="openItemActionModal({{ lb.id }}, 'assign')">Assign</button>
                    <button class="btn xsmall" onclick="openItemActionModal({{ lb.id }}, 'checkout')">Checkout</button>
                  {% elif st_lower == 'assigned' %}
                    <button class="btn xsmall" onclick="openItemActionModal({{ lb.id }}, 'unassign')">Unassign</button>
                  {% elif st_lower == 'checked_out' %}
                    <button class="btn xsmall" onclick="openItemActionModal({{ lb.id }}, 'checkin')">Checkin</button>
                  {% endif %}

                  {% if viewer_role in ['admin', 'owner'] %}
                    <a class="btn xsmall danger" href="{{ url_for('inventory.delete_lockbox', item_id=lb.id) }}" onclick="return confirm('Delete this lockbox?')">Delete</a>
                  {% endif %}
                {% else %}
                  <a class="btn xsmall" href="{{ url_for('inventory.item_details', item_id=lb.id) }}">View</a>
                {% endif %}
              </div>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  {% else %}
    <p class="muted">No lockboxes found. <a href="{{ url_for('inventory.add_lockbox') }}">Add your first lockbox</a>.</p>
  {% endif %}
</div>

<script>
  // Export menu functionality
  let exportMenuData = null;

  function showExportMenu(event, itemType) {
    event.preventDefault();
    const menu = document.getElementById('export-menu');
    const button = event.target;
    const rect = button.getBoundingClientRect();

    menu.style.left = rect.left + 'px';
    menu.style.top = (rect.bottom + 5) + 'px';
    menu.style.display = 'block';
    exportMenuData = itemType;

    // Close menu when clicking outside
    setTimeout(() => {
      document.addEventListener('click', closeExportMenu);
    }, 0);
  }

  function closeExportMenu(event) {
    const menu = document.getElementById('export-menu');
    if (event && menu.contains(event.target)) return;
    menu.style.display = 'none';
    document.removeEventListener('click', closeExportMenu);
  }

  function exportData(event, format) {
    event.preventDefault();
    if (!exportMenuData) return;

    const url = `/exports/items/${exportMenuData}?format=${format}`;
    window.location.href = url;
    closeExportMenu();
  }

  // === Filter and Bulk Operations ===

  function toggleFilters() {
    const filtersDiv = document.getElementById('advanced-filters');
    if (filtersDiv.style.display === 'none' || filtersDiv.style.display === '') {
      filtersDiv.style.display = 'block';
    } else {
      filtersDiv.style.display = 'none';
    }
  }

  function getSelectedItems() {
    const checkboxes = document.querySelectorAll('.item-checkbox:checked');
    return Array.from(checkboxes).map(cb => cb.value);
  }

  function updateBulkToolbar() {
    const selectedIds = getSelectedItems();
    const toolbar = document.getElementById('bulk-toolbar');
    const countSpan = document.getElementById('bulk-count');
    const selectAllCheckbox = document.getElementById('select-all-checkbox');
    const thSelectAll = document.getElementById('th-select-all');

    if (selectedIds.length > 0) {
      toolbar.classList.add('show');
      countSpan.textContent = `${selectedIds.length} selected`;
    } else {
      toolbar.classList.remove('show');
      countSpan.textContent = '0 selected';
    }

    // Update select-all checkbox state
    const allCheckboxes = document.querySelectorAll('.item-checkbox');
    const allChecked = allCheckboxes.length > 0 && selectedIds.length === allCheckboxes.length;
    if (selectAllCheckbox) selectAllCheckbox.checked = allChecked;
    if (thSelectAll) thSelectAll.checked = allChecked;
  }

  function toggleSelectAll(checkbox) {
    const checkboxes = document.querySelectorAll('.item-checkbox');
    checkboxes.forEach(cb => {
      cb.checked = checkbox.checked;
    });
    updateBulkToolbar();
  }

  function clearSelection() {
    const checkboxes = document.querySelectorAll('.item-checkbox');
    checkboxes.forEach(cb => {
      cb.checked = false;
    });
    updateBulkToolbar();
  }

  function getCsrfToken() {
    return document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
  }

  async function executeBulkAction() {
    const selectedIds = getSelectedItems();
    if (selectedIds.length === 0) {
      alert('Please select at least one item.');
      return;
    }

    const action = document.getElementById('bulk-action').value;
    if (!action) {
      alert('Please select an action.');
      return;
    }

    if (action === 'delete') {
      if (!confirm(`Are you sure you want to delete ${selectedIds.length} item(s)? This cannot be undone.`)) {
        return;
      }
      await bulkDelete(selectedIds);
    } else if (action === 'change-status') {
      const newStatus = prompt('Enter new status (available, assigned, checked_out, maintenance, retired):');
      if (newStatus) {
        await bulkUpdateStatus(selectedIds, newStatus);
      }
    } else if (action === 'assign') {
      const assignTo = prompt('Enter person to assign to (leave blank to unassign):');
      if (assignTo !== null) {
        await bulkAssign(selectedIds, assignTo);
      }
    }
  }

  async function bulkDelete(itemIds) {
    try {
      const response = await fetch('/inventory/bulk/delete', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
          'X-CSRFToken': getCsrfToken()
        },
        body: new URLSearchParams({
          item_ids: itemIds.join(','),
          item_type: 'lockbox'
        })
      });

      const data = await response.json();
      if (data.success) {
        alert(data.message);
        window.location.reload();
      } else {
        alert('Error: ' + data.error);
      }
    } catch (error) {
      alert('Error performing bulk delete: ' + error);
    }
  }

  async function bulkUpdateStatus(itemIds, newStatus) {
    try {
      const response = await fetch('/inventory/bulk/update_status', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
          'X-CSRFToken': getCsrfToken()
        },
        body: new URLSearchParams({
          item_ids: itemIds.join(','),
          status: newStatus
        })
      });

      const data = await response.json();
      if (data.success) {
        alert(data.message);
        window.location.reload();
      } else {
        alert('Error: ' + data.error);
      }
    } catch (error) {
      alert('Error performing bulk status update: ' + error);
    }
  }

  async function bulkAssign(itemIds, assignTo) {
    try {
      const response = await fetch('/inventory/bulk/assign', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
          'X-CSRFToken': getCsrfToken()
        },
        body: new URLSearchParams({
          item_ids: itemIds.join(','),
          assigned_to: assignTo
        })
      });

      const data = await response.json();
      if (data.success) {
        alert(data.message);
        window.location.reload();
      } else {
        alert('Error: ' + data.error);
      }
    } catch (error) {
      alert('Error performing bulk assign: ' + error);
    }
  }
</script>

<!-- Item Actions Modal (for edit/assign/checkout/checkin) -->
<!-- This modal is populated dynamically by item_actions.js -->
<div id="item-action-modal" class="modal-root">
  <div class="modal-backdrop" data-modal-cancel="item-action"></div>
  <div class="modal-dialog">
    <h3 id="item-action-modal-title">Item Action</h3>
    <form id="item-action-modal-form" method="post">
      <div id="item-action-modal-body"></div>
      <div class="modal-actions">
        <button type="button" class="btn ghost" data-modal-cancel="item-action">Cancel</button>
        <button type="submit" id="item-action-modal-submit" class="btn primary">Submit</button>
      </div>
    </form>
  </div>
</div>

<script src="{{ url_for('static', filename='js/modals.js') }}"></script>
<script src="{{ url_for('static', filename='js/item_actions.js') }}"></script>
<script>
  window.kbmItemDetails = {
    itemType: 'lockbox',
    statusOptions: {{ status_options | tojson }},
    propertyOptions: {{ property_select_options | tojson }},
    propertyMap: {{ property_map | tojson }},
    activeCheckoutsUrl: null
  };
</script>

{% endblock %}
