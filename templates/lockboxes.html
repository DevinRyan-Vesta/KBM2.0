{% extends "base.html" %}
{% block title %}Lockboxes - KBM
<!-- Export Menu -->
<div id="export-menu" class="dropdown-menu" style="display: none;">
  <a href="#" onclick="exportData(event, 'csv')">Export as CSV</a>
  <a href="#" onclick="exportData(event, 'excel')">Export as Excel</a>
  <a href="#" onclick="exportData(event, 'pdf')">Export as PDF</a>
</div>


<script>
  // Export menu functionality
  let exportMenuData = null;

  function showExportMenu(event, itemType) {
    event.preventDefault();
    const menu = document.getElementById('export-menu');
    const button = event.target;
    const rect = button.getBoundingClientRect();

    menu.style.left = rect.left + 'px';
    menu.style.top = (rect.bottom + 5) + 'px';
    menu.style.display = 'block';
    exportMenuData = itemType;

    // Close menu on outside click
    setTimeout(() => {
      document.addEventListener('click', closeExportMenu);
    }, 0);
  }

  function closeExportMenu(event) {
    const menu = document.getElementById('export-menu');
    if (event && menu.contains(event.target)) return;
    menu.style.display = 'none';
    document.removeEventListener('click', closeExportMenu);
  }

  function exportData(event, format) {
    event.preventDefault();
    if (!exportMenuData) return;

    showExportPreview(exportMenuData, format);
    closeExportMenu();
  }
</script>


<!-- Export Preview Modal -->
<div id="export-preview-modal" class="modal-root">
  <div class="modal-backdrop" data-modal-cancel="export-preview"></div>
  <div class="modal-dialog" style="max-width: 900px;">
    <h3>Export Preview</h3>
    <div id="preview-content" class="modal-body">
      <p class="muted">Loading preview...</p>
    </div>
    <div class="modal-actions">
      <button type="button" class="btn ghost" data-modal-cancel="export-preview">Cancel</button>
      <button type="button" id="download-csv" class="btn" onclick="downloadExport('csv')">Download CSV</button>
      <button type="button" id="download-excel" class="btn" onclick="downloadExport('excel')">Download Excel</button>
      <button type="button" id="download-pdf" class="btn primary" onclick="downloadExport('pdf')">Download PDF</button>
    </div>
  </div>
</div>

{% endblock %}

{% block content %}
<style>
  .bulkbar {
    display: none;
    align-items: center;
    gap: 12px;
    padding: 10px 14px;
    border-radius: 12px;
    border: 1px solid var(--color-border);
    background: rgba(229, 57, 53, 0.08);
    color: var(--color-text);
    margin-bottom: 18px;
  }
  .bulkbar.show { display: flex; }
  .select-col { width: 40px; }
  .codes { display: flex; gap: 12px; align-items: flex-start; }
  .code-chip { display: inline-flex; flex-direction: column; gap: 4px; }
  .code-chip span {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 10px;
    border-radius: 10px;
    font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
    font-size: 13px;
  }
  .code-chip span.current { background: rgba(229, 57, 53, 0.18); color: #ffb4b4; }
  .code-chip span.previous { background: rgba(148, 163, 184, 0.12); color: var(--color-muted); }
  .row-buttons { display: flex; flex-wrap: wrap; gap: 8px; }
  .actions-col { width: 320px; }

  
  /* Export dropdown menu */
  .dropdown-menu {
    position: absolute;
    background: var(--color-card);
    border: 1px solid var(--color-border);
    border-radius: 8px;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
    z-index: 1000;
    min-width: 150px;
  }
  .dropdown-menu a {
    display: block;
    padding: 10px 14px;
    color: var(--color-text);
    text-decoration: none;
    border-bottom: 1px solid var(--color-border);
    transition: background 0.2s ease;
  }
  .dropdown-menu a:last-child {
    border-bottom: none;
  }
  .dropdown-menu a:hover {
    background: rgba(229, 57, 53, 0.12);
    color: var(--color-accent);
  }
</style>

{% set status_options = status_options or ['available', 'assigned', 'checked_out'] %}
{% set status_options_lower = status_options | map('lower') | list %}

<div class="page-header">
  <h1>Lockboxes</h1>
  <div class="toolbar">
    <form method="get" class="searchbar" action="{{ url_for('inventory.list_lockboxes') }}">
      <input type="text" name="q" placeholder="Search ID, label, address, code..." value="{{ q or '' }}">
      <button class="btn small" type="submit">Search</button>
      {% if q %}
        <a class="btn small" href="{{ url_for('inventory.list_lockboxes') }}">Clear</a>
      {% endif %}
    </form>
    <button type="button" class="btn small" onclick="showExportMenu(event, 'lockboxes')">Export â–¾</button>
    <a class="btn primary" href="{{ url_for('inventory.add_lockbox') }}">Add Lockbox</a>
  </div>
</div>

<form id="bulkForm" method="post" action="{{ url_for('inventory.bulk_lockboxes') }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
  <input type="hidden" name="action" id="bulkAction">
  <div id="bulkbar" class="bulkbar">
    <strong id="selCount">0 selected</strong>
    <button class="btn small" type="button" onclick="submitBulk('assign')">Assign</button>
    <button class="btn small" type="button" onclick="submitBulk('checkout')">Check Out</button>
    <button class="btn small" type="button" onclick="submitBulk('checkin')">Check In</button>
    <span class="muted">|</span>
    <button class="btn small" type="button" onclick="clearSelections()">Clear</button>
  </div>

  <div class="card table-card">
    {% set viewer_role = (current_user.role or '').lower() if current_user.is_authenticated else '' %}
    {% if lockboxes %}
      <table>
        <thead>
          <tr>
            <th class="select-col"><input type="checkbox" id="selectAll"></th>
            <th>Label</th>
            <th>Location</th>
            <th>Address</th>
            <th>Codes</th>
            <th>Status</th>
            <th>Assigned To</th>
            <th>Last Action</th>
            <th class="actions-col">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for lb in lockboxes %}
            {% set status_lower = (lb.status or '')|lower %}
            <tr>
              <td class="select-col">
                <input type="checkbox" name="ids" value="{{ lb.id }}" class="rowcb">
              </td>
              <td>
                <div><strong><a href="{{ url_for('inventory.item_details', item_id=lb.id) }}" style="color: inherit; text-decoration: none;">{{ lb.label }}</a></strong></div>
                <div class="muted">{{ lb.custom_id or '-' }}</div>
              </td>
            <td>
              {% if lb.property %}
                <strong>{{ lb.property.name }}</strong><br>
                <span class="muted text-small">
                  {{ lb.property.address_line1 or '' }}
                  {% if lb.property.city %}, {{ lb.property.city }}{% endif %}
                  {% if lb.property.state %}, {{ lb.property.state }}{% endif %}
                </span><br>
              {% endif %}
              {{ lb.location or '-' }}
            </td>
              <td>{{ lb.address or '-' }}</td>
              <td>
                <div class="codes">
                  <div class="code-chip">
                    <span class="muted text-small">Current</span>
                    <span class="current">{{ lb.code_current or '-' }}</span>
                  </div>
                  <div class="code-chip">
                    <span class="muted text-small">Previous</span>
                    <span class="previous">{{ lb.code_previous or '-' }}</span>
                  </div>
                </div>
              </td>
              <td>
                {% set st_lower = (lb.status or 'Unknown')|lower %}
                <span class="tag {{ 'ok' if st_lower in ['available', 'assigned'] else 'warn' }}">{{ (lb.status or 'Unknown').replace('_',' ')|title }}</span>
              </td>
              <td>{{ lb.assigned_to or '-' }}</td>
              <td>
                {% if lb.last_action %}
                  <div class="muted">
                    {{ lb.last_action.replace('_', ' ')|title }}
                    {% if lb.last_action_at %}<br><span class="text-small">{{ lb.last_action_at.strftime('%Y-%m-%d %H:%M') }}</span>{% endif %}
                  </div>
                {% else %}
                  <span class="muted">-</span>
                {% endif %}
              </td>
              <td>
                <div class="row-buttons">
                  {% if status_lower in ['available'] %}
                    <button class="btn small js-assign" type="button"
                      data-action="{{ url_for('inventory.assign_lockbox', item_id=lb.id) }}"
                      data-label="{{ lb.label|e }}"
                      data-property-id="{{ lb.property_id or '' }}">
                      Assign
                    </button>
                  {% endif %}

                  {% if status_lower in ['available', 'assigned'] %}
                    <button class="btn small js-checkout" type="button"
                      data-action="{{ url_for('inventory.checkout_lockbox', item_id=lb.id) }}"
                      data-label="{{ lb.label|e }}"
                      data-location="{{ lb.location|default('', true)|e }}"
                      data-address="{{ lb.address|default('', true)|e }}"
                      data-assigned="{{ lb.assigned_to|default('', true)|e }}">
                      Check Out
                    </button>
                  {% endif %}

                  {% if status_lower == 'checked_out' %}
                    <button class="btn small js-checkin" type="button"
                      data-action="{{ url_for('inventory.checkin_lockbox', item_id=lb.id) }}"
                      data-label="{{ lb.label|e }}"
                      data-location="{{ lb.location|default('', true)|e }}"
                      data-address="{{ lb.address|default('', true)|e }}">
                      Check In
                    </button>
                  {% endif %}

                  <button class="btn small js-code-update" type="button"
                    data-action="{{ url_for('inventory.update_lockbox_code', item_id=lb.id) }}"
                    data-label="{{ lb.label|e }}"
                    data-location="{{ lb.location|default('', true)|e }}"
                    data-address="{{ lb.address|default('', true)|e }}"
                    data-current-code="{{ lb.code_current|default('', true)|e }}">
                    Update
                  </button>

                  {% if viewer_role != 'agent' %}
                    <form method="post" action="{{ url_for('inventory.delete_lockbox', item_id=lb.id) }}" onsubmit="return confirm('Remove lockbox {{ lb.label }}? This cannot be undone.');">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                      <button class="btn small danger" type="submit">Delete</button>
                    </form>
                  {% endif %}
                  {% if current_user.is_authenticated and (current_user.role or '')|lower == 'admin' %}
                    <button
                      class="btn small js-edit"
                      type="button"
                      data-action="{{ url_for('inventory.edit_lockbox', item_id=lb.id) }}"
                      data-label="{{ lb.label|e }}"
                      data-location="{{ lb.location|default('', true)|e }}"
                      data-address="{{ lb.address|default('', true)|e }}"
                      data-code-current="{{ lb.code_current|default('', true)|e }}"
                      data-code-previous="{{ lb.code_previous|default('', true)|e }}"
                      data-status="{{ (lb.status or '')|lower }}"
                      data-assigned-to="{{ lb.assigned_to|default('', true)|e }}"
                      data-property-id="{{ lb.property_id or '' }}">
                      Edit Details
                    </button>
                  {% endif %}
                </div>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    {% else %}
      <div class="empty-state">No lockboxes found.</div>
    {% endif %}
  </div>
</form>

<div id="action-modal" class="modal-root" aria-hidden="true">
  <div class="modal-backdrop" data-modal-cancel></div>
  <div class="modal-dialog" role="dialog" aria-modal="true" aria-labelledby="action-modal-title">
    <form id="action-modal-form">
      <h3 id="action-modal-title">Action</h3>
      <div id="action-modal-body" class="modal-body"></div>
      <div class="modal-actions">
        <button type="button" class="btn small" data-modal-cancel>Cancel</button>
        <button type="submit" class="btn small primary" id="action-modal-submit">Submit</button>
      </div>
    </form>
  </div>
</div>

<script>
  const statusOptions = {{ status_options_lower | tojson }};
  const propertyOptions = {{ property_select_options|default([])|tojson }};
  const propertyMap = {{ property_map|default({})|tojson }};
  const selectAll = document.getElementById('selectAll');
  const checkboxes = () => Array.from(document.querySelectorAll('.rowcb'));
  const bulkbar = document.getElementById('bulkbar');
  const selCount = document.getElementById('selCount');
  const bulkForm = document.getElementById('bulkForm');
  const bulkAction = document.getElementById('bulkAction');
  const modalRoot = document.getElementById('action-modal');
  const modalForm = document.getElementById('action-modal-form');
  const modalTitle = document.getElementById('action-modal-title');
  const modalBody = document.getElementById('action-modal-body');
  const modalSubmitBtn = document.getElementById('action-modal-submit');
  let modalSubmitHandler = null;

  function updateBulkbar() {
    const count = checkboxes().filter(cb => cb.checked).length;
    selCount.textContent = `${count} selected`;
    bulkbar.classList.toggle('show', count > 0);
  }

  selectAll?.addEventListener('change', (e) => {
    checkboxes().forEach(cb => cb.checked = e.target.checked);
    updateBulkbar();
  });

  checkboxes().forEach(cb => {
    cb.addEventListener('change', updateBulkbar);
  });

  function submitBulk(actionName) {
    bulkAction.value = actionName;
    bulkForm.submit();
  }

  function clearSelections() {
    if (selectAll) {
      selectAll.checked = false;
    }
    checkboxes().forEach(cb => cb.checked = false);
    updateBulkbar();
  }

  function submitAction(url, payload) {
    const form = document.createElement('form');
    form.method = 'post';
    form.action = url;

    // Add CSRF token
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content;
    if (csrfToken) {
      const csrfInput = document.createElement('input');
      csrfInput.type = 'hidden';
      csrfInput.name = 'csrf_token';
      csrfInput.value = csrfToken;
      form.appendChild(csrfInput);
    }

    // Add all payload fields
    Object.entries(payload || {}).forEach(([key, value]) => {
      const input = document.createElement('input');
      input.type = 'hidden';
      input.name = key;
      input.value = value ?? '';
      form.appendChild(input);
    });

    // Add 'next' parameter from URL if present
    const urlParams = new URLSearchParams(window.location.search);
    const nextUrl = urlParams.get('next');
    if (nextUrl) {
      const nextInput = document.createElement('input');
      nextInput.type = 'hidden';
      nextInput.name = 'next';
      nextInput.value = nextUrl;
      form.appendChild(nextInput);
    }

    document.body.appendChild(form);
    form.submit();
  }

  function closeModal() {
    modalRoot.classList.remove('show');
    document.body.classList.remove('modal-open');
    modalSubmitHandler = null;
    modalBody.innerHTML = '';
    modalTitle.textContent = 'Action';
    modalSubmitBtn.textContent = 'Submit';
    modalForm.reset();
  }

  function openModal({ title, submitLabel, fields, onSubmit }) {
    modalTitle.textContent = title || 'Action';
    modalSubmitBtn.textContent = submitLabel || 'Submit';
    modalBody.innerHTML = '';

    fields.forEach((field) => {
      const wrapper = document.createElement('div');
      wrapper.className = 'modal-field';

      const label = document.createElement('label');
      const fieldId = `modal-${field.name}`;
      label.setAttribute('for', fieldId);
      label.textContent = field.label + (field.required ? ' *' : '');

      let input;
      if (field.widget === 'select') {
        input = document.createElement('select');
        input.id = fieldId;
        input.name = field.name;
        const options = field.options || [];
        const currentValue = (field.defaultValue || '').toString().toLowerCase();
        options.forEach((opt) => {
          const option = document.createElement('option');
          const value = Array.isArray(opt) ? opt[0] : opt;
          const labelText = Array.isArray(opt) ? opt[1] : opt;
          option.value = value;
          option.textContent = labelText.toString().replace(/_/g, ' ');
          if (value.toString().toLowerCase() === currentValue) {
            option.selected = true;
          }
          input.appendChild(option);
        });
      } else {
        const elementType = field.type === 'textarea' ? 'textarea' : 'input';
        input = document.createElement(elementType);
        if (elementType === 'input') {
          input.type = field.type || 'text';
        }
        input.placeholder = field.placeholder || '';
        input.value = field.defaultValue || '';
      }

      input.id = fieldId;
      input.name = field.name;
      input.required = Boolean(field.required);

      wrapper.appendChild(label);
      wrapper.appendChild(input);
      if (field.help) {
        const help = document.createElement('small');
        help.className = 'muted';
        help.textContent = field.help;
        wrapper.appendChild(help);
      }
      modalBody.appendChild(wrapper);
    });

    modalSubmitHandler = onSubmit;
    modalRoot.classList.add('show');
    document.body.classList.add('modal-open');
    const firstInput = modalBody.querySelector('input, textarea, select');
    if (firstInput) {
      setTimeout(() => firstInput.focus(), 50);
    }
  }

  modalForm.addEventListener('submit', (event) => {
    event.preventDefault();
    if (typeof modalSubmitHandler === 'function') {
      const formData = new FormData(modalForm);
      const result = modalSubmitHandler(formData);
      if (result === false) {
        return;
      }
    }
    closeModal();
  });

  modalRoot.querySelectorAll('[data-modal-cancel]').forEach((el) => {
    el.addEventListener('click', () => closeModal());
  });

  window.addEventListener('keydown', (event) => {
    if (event.key === 'Escape' && modalRoot.classList.contains('show')) {
      closeModal();
    }
  });

  document.querySelectorAll('.js-checkout').forEach((button) => {
    button.addEventListener('click', () => {
      const actionUrl = button.dataset.action;
      if (!actionUrl) return;
      const label = button.dataset.label || 'lockbox';
      openModal({
        title: `Check Out ${label}`,
        submitLabel: "Check Out",
        fields: [
          { name: 'code', label: 'Current Code', required: true },
          { name: 'assigned_to', label: 'Assign To', defaultValue: button.dataset.assigned || '', placeholder: 'Optional' },
          { name: 'location', label: 'Location', defaultValue: button.dataset.location || '', placeholder: 'Optional' },
          { name: 'address', label: 'Address', defaultValue: button.dataset.address || '', placeholder: 'Optional' },
        ],
        onSubmit(formValues) {
          const code = (formValues.get('code') || '').trim();
          if (!code) return false;
          submitAction(actionUrl, {
            code,
            assigned_to: (formValues.get('assigned_to') || '').trim(),
            location: (formValues.get('location') || '').trim(),
            address: (formValues.get('address') || '').trim(),
          });
        }
      });
    });
  });

  document.querySelectorAll('.js-checkin').forEach((button) => {
    button.addEventListener('click', () => {
      const actionUrl = button.dataset.action;
      if (!actionUrl) return;
      const label = button.dataset.label || 'lockbox';
      openModal({
        title: `Check In ${label}`,
        submitLabel: "Check In",
        fields: [
          { name: 'code', label: 'Confirm Code', required: true },
          { name: 'location', label: 'Location', defaultValue: button.dataset.location || '', placeholder: 'Optional' },
          { name: 'address', label: 'Address', defaultValue: button.dataset.address || '', placeholder: 'Optional' },
        ],
        onSubmit(formValues) {
          const code = (formValues.get('code') || '').trim();
          if (!code) return false;
          submitAction(actionUrl, {
            code,
            location: (formValues.get('location') || '').trim(),
            address: (formValues.get('address') || '').trim(),
          });
        }
      });
    });
  });

  document.querySelectorAll('.js-code-update').forEach((button) => {
    button.addEventListener('click', () => {
      const actionUrl = button.dataset.action;
      if (!actionUrl) return;
      const label = button.dataset.label || 'lockbox';
      openModal({
        title: `Update Code for ${label}`,
        submitLabel: "Update",
        fields: [
          { name: 'code', label: 'New Code', required: true, defaultValue: button.dataset.currentCode || '' },
          { name: 'location', label: 'Location', defaultValue: button.dataset.location || '', placeholder: 'Optional' },
          { name: 'address', label: 'Address', defaultValue: button.dataset.address || '', placeholder: 'Optional' },
        ],
        onSubmit(formValues) {
          const code = (formValues.get('code') || '').trim();
          if (!code) return false;
          submitAction(actionUrl, {
            code,
            location: (formValues.get('location') || '').trim(),
            address: (formValues.get('address') || '').trim(),
          });
        }
      });
    });
  });

  document.querySelectorAll('.js-edit').forEach((button) => {
    button.addEventListener('click', () => {
      const actionUrl = button.dataset.action;
      if (!actionUrl) return;
      const label = button.dataset.label || 'lockbox';
      openModal({
        title: `Edit ${label}`,
        submitLabel: "Save Changes",
        fields: [
          { name: 'label', label: 'Label', required: true, defaultValue: button.dataset.label || '' },
          { name: 'location', label: 'Location', defaultValue: button.dataset.location || '', placeholder: 'Optional' },
          { name: 'address', label: 'Address', defaultValue: button.dataset.address || '', placeholder: 'Optional' },
          { name: 'property_id', label: 'Property', widget: 'select', options: propertyOptions, defaultValue: button.dataset.propertyId || '' },
          { name: 'code_current', label: 'Current Code', defaultValue: button.dataset.codeCurrent || '' },
          { name: 'code_previous', label: 'Previous Code', defaultValue: button.dataset.codePrevious || '' },
          { name: 'status', label: 'Status', widget: 'select', options: statusOptions, defaultValue: (button.dataset.status || '').toLowerCase() },
          { name: 'assigned_to', label: 'Assigned To', defaultValue: button.dataset.assignedTo || '', placeholder: 'Optional' },
        ],
        onSubmit(formValues) {
          const payload = {
            label: (formValues.get('label') || '').trim(),
            location: (formValues.get('location') || '').trim(),
          address: (formValues.get('address') || '').trim(),
          property_id: (formValues.get('property_id') || '').trim(),
          code_current: (formValues.get('code_current') || '').trim(),
          code_previous: (formValues.get('code_previous') || '').trim(),
          status: (formValues.get('status') || '').trim(),
          assigned_to: (formValues.get('assigned_to') || '').trim(),
        };

          if (!payload.label) {
            return false;
          }

          submitAction(actionUrl, payload);
        }
      });
    });
  });

  document.querySelectorAll('.js-assign').forEach((button) => {
    button.addEventListener('click', () => {
      const actionUrl = button.dataset.action;
      if (!actionUrl) return;
      const label = button.dataset.label || 'lockbox';
      openModal({
        title: `Assign ${label}`,
        submitLabel: "Assign",
        fields: [
          { name: 'assignee', label: 'Assigned To', placeholder: 'Name or company (optional when assigning to property)' },
          { name: 'assignment_type', label: 'Assignment Type', widget: 'select', required: true, options: ['agent', 'property', 'contractor'] },
          { name: 'expected_return_date', label: 'Expected Return Date', type: 'date', placeholder: 'Required for contractors' },
          { name: 'property_id', label: 'Property', widget: 'select', options: propertyOptions, defaultValue: button.dataset.propertyId || '' },
          { name: 'address', label: 'Property Address', placeholder: 'Optional' },
          { name: 'location', label: 'Location', placeholder: 'Optional' },
        ],
        onSubmit(formValues) {
          const assignmentType = formValues.get('assignment_type');
          const expectedReturn = formValues.get('expected_return_date');
          const propertyId = (formValues.get('property_id') || '').trim();
          let assigneeValue = (formValues.get('assignee') || '').trim();
          let addressValue = (formValues.get('address') || '').trim();
          const locationValue = (formValues.get('location') || '').trim();

          if (assignmentType === 'contractor' && !expectedReturn) {
            alert('Expected return date is required for contractor assignments');
            return false;
          }

          if (assignmentType === 'property') {
            if (!propertyId) {
              alert('Select a property for this assignment.');
              return false;
            }
            const propertyInfo = propertyMap[propertyId] || null;
            if (!assigneeValue && propertyInfo) {
              assigneeValue = propertyInfo.name || '';
            }
            if (!addressValue && propertyInfo) {
              const parts = [propertyInfo.address?.line1, propertyInfo.address?.city, propertyInfo.address?.state, propertyInfo.address?.postal_code];
              addressValue = parts.filter(Boolean).join(', ');
            }
          } else if (!assigneeValue) {
            alert('Please specify who the lockbox is assigned to.');
            return false;
          }

          submitAction(actionUrl, {
            assignee: assigneeValue,
            assignment_type: assignmentType,
            expected_return_date: expectedReturn,
            property_id: propertyId,
            address: addressValue,
            location: locationValue,
          });
        }
      });
    });
  });
</script>


<!-- Export Menu -->
<div id="export-menu" class="dropdown-menu" style="display: none;">
  <a href="#" onclick="exportData(event, 'csv')">Export as CSV</a>
  <a href="#" onclick="exportData(event, 'excel')">Export as Excel</a>
  <a href="#" onclick="exportData(event, 'pdf')">Export as PDF</a>
</div>


<script>
  // Export menu functionality
  let exportMenuData = null;

  function showExportMenu(event, itemType) {
    event.preventDefault();
    const menu = document.getElementById('export-menu');
    const button = event.target;
    const rect = button.getBoundingClientRect();

    menu.style.left = rect.left + 'px';
    menu.style.top = (rect.bottom + 5) + 'px';
    menu.style.display = 'block';
    exportMenuData = itemType;

    // Close menu on outside click
    setTimeout(() => {
      document.addEventListener('click', closeExportMenu);
    }, 0);
  }

  function closeExportMenu(event) {
    const menu = document.getElementById('export-menu');
    if (event && menu.contains(event.target)) return;
    menu.style.display = 'none';
    document.removeEventListener('click', closeExportMenu);
  }

  function exportData(event, format) {
    event.preventDefault();
    if (!exportMenuData) return;

    showExportPreview(exportMenuData, format);
    closeExportMenu();
  }
</script>


<!-- Export Preview Modal -->
<div id="export-preview-modal" class="modal-root">
  <div class="modal-backdrop" data-modal-cancel="export-preview"></div>
  <div class="modal-dialog" style="max-width: 900px;">
    <h3>Export Preview</h3>
    <div id="preview-content" class="modal-body">
      <p class="muted">Loading preview...</p>
    </div>
    <div class="modal-actions">
      <button type="button" class="btn ghost" data-modal-cancel="export-preview">Cancel</button>
      <button type="button" id="download-csv" class="btn" onclick="downloadExport('csv')">Download CSV</button>
      <button type="button" id="download-excel" class="btn" onclick="downloadExport('excel')">Download Excel</button>
      <button type="button" id="download-pdf" class="btn primary" onclick="downloadExport('pdf')">Download PDF</button>
    </div>
  </div>
</div>

{% endblock %}
