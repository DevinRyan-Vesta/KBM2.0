{% extends "base.html" %}
{% block title %}Properties - KBM
<!-- Export Menu -->
<div id="export-menu" class="dropdown-menu" style="display: none;">
  <a href="#" onclick="exportData(event, 'csv')">Export as CSV</a>
  <a href="#" onclick="exportData(event, 'excel')">Export as Excel</a>
  <a href="#" onclick="exportData(event, 'pdf')">Export as PDF</a>
</div>


<script>
  // Export menu functionality
  let exportMenuData = null;

  function showExportMenu(event, itemType) {
    event.preventDefault();
    const menu = document.getElementById('export-menu');
    const button = event.target;
    const rect = button.getBoundingClientRect();

    menu.style.left = rect.left + 'px';
    menu.style.top = (rect.bottom + 5) + 'px';
    menu.style.display = 'block';
    exportMenuData = itemType;

    // Close menu on outside click
    setTimeout(() => {
      document.addEventListener('click', closeExportMenu);
    }, 0);
  }

  function closeExportMenu(event) {
    const menu = document.getElementById('export-menu');
    if (event && menu.contains(event.target)) return;
    menu.style.display = 'none';
    document.removeEventListener('click', closeExportMenu);
  }

  function exportData(event, format) {
    event.preventDefault();
    if (!exportMenuData) return;

    showExportPreview(exportMenuData, format);
    closeExportMenu();
  }
</script>


<!-- Export Preview Modal -->
<div id="export-preview-modal" class="modal-root">
  <div class="modal-backdrop" data-modal-cancel="export-preview"></div>
  <div class="modal-dialog" style="max-width: 900px;">
    <h3>Export Preview</h3>
    <div id="preview-content" class="modal-body">
      <p class="muted">Loading preview...</p>
    </div>
    <div class="modal-actions">
      <button type="button" class="btn ghost" data-modal-cancel="export-preview">Cancel</button>
      <button type="button" id="download-csv" class="btn" onclick="downloadExport('csv')">Download CSV</button>
      <button type="button" id="download-excel" class="btn" onclick="downloadExport('excel')">Download Excel</button>
      <button type="button" id="download-pdf" class="btn primary" onclick="downloadExport('pdf')">Download PDF</button>
    </div>
  </div>
</div>

{% endblock %}

{% block content %}
<div class="page-header">
  <h1>Properties</h1>
  <div class="toolbar">
    <form method="get" class="searchbar" action="{{ url_for('properties.list_properties') }}">
      <input type="text" name="q" placeholder="Search by name or address" value="{{ q or '' }}">
      <button class="btn small" type="submit">Search</button>
      {% if q %}
        <a class="btn small" href="{{ url_for('properties.list_properties') }}">Clear</a>
      {% endif %}
    </form>
    <a class="btn primary" href="{{ url_for('properties.create_property') }}">Add Property</a>
  </div>
</div>

<div class="grid cols-2" style="gap: 20px;">
  {% for summary in properties %}
    {% set prop = summary.property %}
    <div class="card">
      <div class="toolbar spaced" style="align-items: flex-start;">
        <div>
          <h2 style="margin: 0 0 6px 0;">{{ prop.name }}</h2>
          <div class="muted">{{ prop.address_line1 }}{% if prop.city %}, {{ prop.city }}{% endif %}{% if prop.state %}, {{ prop.state }}{% endif %}</div>
          <div class="muted text-small" style="margin-top: 4px;">{{ (prop.type or 'Unknown').replace('_',' ')|title }}</div>
        </div>
        <a class="btn" href="{{ url_for('properties.property_detail', property_id=prop.id) }}">View</a>
      </div>
      <div class="divider"></div>
      <div class="info-grid" style="grid-template-columns: repeat(3, minmax(100px, 1fr));">
        <div class="info-item">
          <div class="info-label">Total Items</div>
          <div class="info-value large">{{ summary.item_count }}</div>
        </div>
        <div class="info-item">
          <div class="info-label">Keys</div>
          <div class="info-value large">{{ summary.key_count }}</div>
        </div>
        <div class="info-item">
          <div class="info-label">Lockboxes</div>
          <div class="info-value large">{{ summary.lockbox_count }}</div>
        </div>
      </div>
    </div>
  {% else %}
    <div class="card">
      <div class="empty-state">No properties found.</div>
    </div>
  {% endfor %}
</div>

<!-- Export Menu -->
<div id="export-menu" class="dropdown-menu" style="display: none;">
  <a href="#" onclick="exportData(event, 'csv')">Export as CSV</a>
  <a href="#" onclick="exportData(event, 'excel')">Export as Excel</a>
  <a href="#" onclick="exportData(event, 'pdf')">Export as PDF</a>
</div>


<script>
  // Export menu functionality
  let exportMenuData = null;

  function showExportMenu(event, itemType) {
    event.preventDefault();
    const menu = document.getElementById('export-menu');
    const button = event.target;
    const rect = button.getBoundingClientRect();

    menu.style.left = rect.left + 'px';
    menu.style.top = (rect.bottom + 5) + 'px';
    menu.style.display = 'block';
    exportMenuData = itemType;

    // Close menu on outside click
    setTimeout(() => {
      document.addEventListener('click', closeExportMenu);
    }, 0);
  }

  function closeExportMenu(event) {
    const menu = document.getElementById('export-menu');
    if (event && menu.contains(event.target)) return;
    menu.style.display = 'none';
    document.removeEventListener('click', closeExportMenu);
  }

  function exportData(event, format) {
    event.preventDefault();
    if (!exportMenuData) return;

    showExportPreview(exportMenuData, format);
    closeExportMenu();
  }
</script>


<!-- Export Preview Modal -->
<div id="export-preview-modal" class="modal-root">
  <div class="modal-backdrop" data-modal-cancel="export-preview"></div>
  <div class="modal-dialog" style="max-width: 900px;">
    <h3>Export Preview</h3>
    <div id="preview-content" class="modal-body">
      <p class="muted">Loading preview...</p>
    </div>
    <div class="modal-actions">
      <button type="button" class="btn ghost" data-modal-cancel="export-preview">Cancel</button>
      <button type="button" id="download-csv" class="btn" onclick="downloadExport('csv')">Download CSV</button>
      <button type="button" id="download-excel" class="btn" onclick="downloadExport('excel')">Download Excel</button>
      <button type="button" id="download-pdf" class="btn primary" onclick="downloadExport('pdf')">Download PDF</button>
    </div>
  </div>
</div>

{% endblock %}

