{% extends "base.html" %}

{% block title %}Create Your Account{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto">
    <div class="bg-white shadow-md rounded-lg p-8">
        <h1 class="text-3xl font-bold mb-2 text-gray-800">Create Your Company Account</h1>
        <p class="text-gray-600 mb-6">Start managing your keys, lockboxes, and signs today</p>

        <form method="POST" id="signup-form" class="space-y-6">
            <!-- Company Information -->
            <div class="border-b pb-4">
                <h2 class="text-xl font-semibold mb-4 text-gray-700">Company Information</h2>

                <div class="mb-4">
                    <label for="company_name" class="block text-sm font-medium text-gray-700 mb-2">
                        Company Name *
                    </label>
                    <input
                        type="text"
                        id="company_name"
                        name="company_name"
                        value="{{ company_name or '' }}"
                        required
                        class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        placeholder="Vesta Real Estate"
                    >
                </div>

                <div class="mb-4">
                    <label for="subdomain" class="block text-sm font-medium text-gray-700 mb-2">
                        Choose Your Subdomain *
                    </label>
                    <div class="flex items-center">
                        <input
                            type="text"
                            id="subdomain"
                            name="subdomain"
                            value="{{ subdomain or '' }}"
                            required
                            pattern="[a-z0-9][a-z0-9-]*[a-z0-9]"
                            minlength="3"
                            maxlength="63"
                            class="flex-1 px-4 py-2 border border-gray-300 rounded-l-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                            placeholder="vesta"
                        >
                        <span class="px-4 py-2 bg-gray-100 border border-l-0 border-gray-300 rounded-r-md text-gray-600">
                            .{{ request.host.split(':')[0] if 'localhost' not in request.host else 'localhost' }}{{ ':' + request.host.split(':')[1] if ':' in request.host else '' }}
                        </span>
                    </div>
                    <p class="mt-1 text-xs text-gray-500">
                        Your team will access the system at this address. Use lowercase letters, numbers, and hyphens only.
                    </p>
                    <div id="subdomain-feedback" class="mt-2 text-sm"></div>
                </div>
            </div>

            <!-- Admin Account -->
            <div class="border-b pb-4">
                <h2 class="text-xl font-semibold mb-4 text-gray-700">Admin Account</h2>
                <p class="text-sm text-gray-600 mb-4">Create your administrator account. You'll be able to add team members later.</p>

                <div class="mb-4">
                    <label for="admin_name" class="block text-sm font-medium text-gray-700 mb-2">
                        Your Name *
                    </label>
                    <input
                        type="text"
                        id="admin_name"
                        name="admin_name"
                        value="{{ admin_name or '' }}"
                        required
                        class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        placeholder="John Smith"
                    >
                </div>

                <div class="mb-4">
                    <label for="admin_email" class="block text-sm font-medium text-gray-700 mb-2">
                        Email Address *
                    </label>
                    <input
                        type="email"
                        id="admin_email"
                        name="admin_email"
                        value="{{ admin_email or '' }}"
                        required
                        class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        placeholder="john@vesta.com"
                    >
                </div>

                <div class="mb-4">
                    <label for="admin_pin" class="block text-sm font-medium text-gray-700 mb-2">
                        PIN (4+ characters) *
                    </label>
                    <input
                        type="password"
                        id="admin_pin"
                        name="admin_pin"
                        required
                        minlength="4"
                        class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        placeholder="Enter a secure PIN"
                    >
                </div>

                <div class="mb-4">
                    <label for="admin_pin_confirm" class="block text-sm font-medium text-gray-700 mb-2">
                        Confirm PIN *
                    </label>
                    <input
                        type="password"
                        id="admin_pin_confirm"
                        name="admin_pin_confirm"
                        required
                        minlength="4"
                        class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        placeholder="Re-enter your PIN"
                    >
                </div>
            </div>

            <!-- Submit -->
            <div class="flex items-center justify-between">
                <p class="text-xs text-gray-500">* Required fields</p>
                <button
                    type="submit"
                    class="px-6 py-3 bg-blue-600 text-white font-medium rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors"
                >
                    Create Account
                </button>
            </div>
        </form>
    </div>
</div>

<script>
// Real-time subdomain validation
const subdomainInput = document.getElementById('subdomain');
const feedbackDiv = document.getElementById('subdomain-feedback');
let debounceTimer;

subdomainInput.addEventListener('input', function() {
    clearTimeout(debounceTimer);

    const subdomain = this.value.toLowerCase().trim();

    // Update input to lowercase
    this.value = subdomain;

    if (subdomain.length < 3) {
        feedbackDiv.innerHTML = '';
        return;
    }

    feedbackDiv.innerHTML = '<span class="text-gray-500">Checking availability...</span>';

    debounceTimer = setTimeout(() => {
        fetch(`/accounts/check-subdomain?subdomain=${encodeURIComponent(subdomain)}`)
            .then(response => response.json())
            .then(data => {
                if (data.available) {
                    feedbackDiv.innerHTML = `<span class="text-green-600">✓ ${data.message}</span>`;
                } else {
                    feedbackDiv.innerHTML = `<span class="text-red-600">✗ ${data.message}</span>`;
                }
            })
            .catch(error => {
                console.error('Error checking subdomain:', error);
            });
    }, 500);
});

// PIN confirmation validation
const form = document.getElementById('signup-form');
form.addEventListener('submit', function(e) {
    const pin = document.getElementById('admin_pin').value;
    const pinConfirm = document.getElementById('admin_pin_confirm').value;

    if (pin !== pinConfirm) {
        e.preventDefault();
        alert('PINs do not match. Please check and try again.');
        return false;
    }
});
</script>
{% endblock %}
