services:
  # Permission fixer service - runs once on startup to fix .git permissions
  git-permissions:
    image: alpine:latest
    container_name: git-permissions-fixer
    volumes:
      - ./.git:/git
    command: sh -c "chmod -R 777 /git && echo 'Git permissions fixed'"
    restart: "no"

  python-app:
    build:
      context: .
    container_name: python-app
    restart: unless-stopped
    init: true
    env_file:
      - .env
    expose:
      - "8000"  # Internal port only, not exposed to host
    depends_on:
      git-permissions:
        condition: service_completed_successfully
    volumes:
      - ./.git:/app/.git                 # Mount git directory for updates (writable for fetch)
      - ./compose.yaml:/app/compose.yaml:ro  # Mount compose file for docker compose commands
      - ./.env:/app/.env:ro              # Mount .env file for docker compose commands
      - ./master_db:/app/master_db       # Persist master database
      - ./tenant_dbs:/app/tenant_dbs     # Persist tenant databases
      - /volume1/KBM/backups:/app/backups  # Database backups directory
      - /var/run/docker.sock:/var/run/docker.sock  # Docker socket for container management
      # Mount source code for live updates without rebuilding
      - ./templates:/app/templates       # Templates
      - ./static:/app/static             # Static files
      - ./audits:/app/audits             # Audits blueprint
      - ./auth:/app/auth                 # Auth blueprint
      - ./inventory:/app/inventory       # Inventory blueprint
      - ./checkout:/app/checkout         # Checkout blueprint
      - ./contacts:/app/contacts         # Contacts blueprint
      - ./properties:/app/properties     # Properties blueprint
      - ./smartlocks:/app/smartlocks     # Smart locks blueprint
      - ./accounts:/app/accounts         # Accounts blueprint
      - ./app_admin:/app/app_admin       # App admin blueprint
      - ./main:/app/main                 # Main blueprint
      - ./exports:/app/exports           # Exports blueprint
      - ./utilities:/app/utilities       # Utilities
      - ./middleware:/app/middleware     # Middleware
    networks:
      - appnet

  nginx:
    image: nginx:alpine
    container_name: nginx-proxy
    restart: unless-stopped
    ports:
      - "8080:80"   # HTTP - Map NAS port 8080 to container port 80
      - "8443:443"  # HTTPS - Map NAS port 8443 to container port 443
      # Ports 80 and 443 are used by NAS web interface
      # When using Cloudflare Tunnel, nginx serves HTTP only (Cloudflare handles SSL)
    volumes:
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro  # HTTP-only config for Cloudflare Tunnel
    depends_on:
      - python-app
    networks:
      - appnet

# If you add external services (e.g., PostgreSQL), uncomment and configure below:
#  postgres:
#    image: postgres:latest
#    restart: unless-stopped
#    environment:
#      POSTGRES_USER: exampleuser
#      POSTGRES_PASSWORD: examplepass
#      POSTGRES_DB: exampledb
#    volumes:
#      - postgres_data:/var/lib/postgresql/data
#    healthcheck:
#      test: ["CMD-SHELL", "pg_isready -U exampleuser"]
#      interval: 10s
#      timeout: 5s
#      retries: 5
#    networks:
#      - appnet

networks:
  appnet:
    driver: bridge

# volumes:
#   postgres_data:
#     driver: local
